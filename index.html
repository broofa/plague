<!DOCTYPE html>
<html>
	<head>
    <script src="plague.js"></script>
		<style>
html {
  overflow: hidden;
}
      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
          font-size: 10pt;
      }
      #console {
        position: fixed;
        right: 0;
        padding: 10px;
        top: 0;
        bottom: 0;
        width: 275px;
        border-left: solid 1px black;
        background: white;
      }
      h3 {
        text-align: center;
          margin: 10px 0px 5px;
      }
      #board {
        image-rendering: pixelated;
      }
      .bar {
        margin: 10px;
        height: 20px;
        color: white;
        background-color: black;
      }

      label {
        display: block;
        margin: 5px 0px;
      }
      label span {
        display: inline-block;
          width: 150px;
        font-size: 80%;
        font-family:monospace;
      }

      input[type="range"] {
        width: 100px;
      }

      canvas#colors {display: none;}
      body.mode-all canvas#colors {display: block;}

      button {width: 100%; margin: 5px 0;}
      button:active {background-color: red;}
		</style>
	</head>

	<body>
    <div id="console">
      <label><span>IMMUNE_ENTROPY</span><input id="IMMUNE_ENTROPY" type="range" min=0 max=2 step=.02 /></label>
      <label><span>IMMUNE_BOOST</span><input id="IMMUNE_BOOST" type="range" min=0 max=255 step=1 /></label>
      <label><span>LIFE_MAX</span><input id="LIFE_MAX" type="range" min=0 max=255 step=1 /></label>
      <label><span>MUTATION</span><input id="MUTATION" type="range" min=0 max=.20 step=.005 /></label>

      <div><button style="font-size:20px" onmousedown="vaccinate(true)" onmouseup="vaccinate(false)" >Vaccinate</button></div>

      <h3>Immunity & Infection</h3>
      <canvas id="graph" width="275" height="200"></canvas>

      <h3>Population Distributions</h3>
      <canvas id="colors" width="275" height="200"></canvas>
    </div>
    <canvas id="board"></canvas>
	</body>
  <script>
    function $(sel, target = document) {return target.querySelector(sel);}

    // Table to map hue (0-255) to RGB values
    const HSB = new Array(256);
    for (let i = 0; i < 256; i++) {
      let a = i*360/255;
      let r=0, g=0, b=0;
      if (a < 60) {
        r = 255;
        g = a*255/60;
      } else if (a < 120) {
        a-= 60;
        r = 255 - (a*255/60);
        g = 255;
      } else if (a < 180) {
        a-= 120;
        g = 255;
        b = a*255/60;
      } else if (a < 240) {
        a-= 180;
        g = 255 - (a*255/60);
        b = 255;
      } else if (a < 300) {
        a-= 240;
        r = a*255/60;
        b = 255;
      } else {
        a-= 300;
        r = 255;
        b = 255 - (a*255/60);
      }

      HSB[i] = [r | 0, g | 0, b | 0];
    }

    let plague;
    let frame = 0;
    let maxFrame = Number.POSITIVE_INFINITY;
    let circles = [];
    let stats = [];

    function vaccinate(flag) {
      plague.isVaccinated = flag;
    }

    let viewMode = 0;
    function setViewMode(mode) {
      viewMode = mode > 2 ? 0 : mode;
      ['mode-all', 'mode-infected', 'mode-immune'].forEach((m, i) => {
        document.body.classList.toggle(m, i == viewMode);
      })
      renderBoard();
    }

    function renderGraph() {
      const canvas = $('#graph');
      const {width: w, height: h} = canvas;
      var ctx = canvas.getContext('2d');

      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, w, h);

      ctx.lineWidth = 4;

      ctx.strokeStyle = 'cyan';
      ctx.beginPath();
      for (let i = 0; i < stats.length; i++) {
        const stat = stats[i];
        const x = i / stats.length * w;
        const y = h * (1 - stat.immunity / 100);
        if (i != 0) {
          ctx.lineTo(x, y);
        } else {
          ctx.moveTo(x, y);
        }
      }
      ctx.stroke();

      ctx.strokeStyle = 'red';
      ctx.beginPath();
      for (let i = 0; i < stats.length; i++) {
        const stat = stats[i];
        const x = i / stats.length * w;
        const y = h * (1 - stat.infected / 100);
        if (i != 0) {
          ctx.lineTo(x, y);
        } else {
          ctx.moveTo(x, y);
        }
      }
      ctx.stroke();
    }

    function renderColors() {
      const canvas = $('#colors');
      const {width: w, height: h} = canvas;
      var ctx = canvas.getContext('2d');

      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, w, h);

      ctx.lineWidth = 4;

      ctx.beginPath();
      const nCells = plague.nCells;
      for (let c = 0; c < 8; c++) {
        ctx.strokeStyle = `hsl(${c * 45 + 22.5}, 100%, 50%)`;
        ctx.beginPath();
        for (let i = 0; i < stats.length; i++) {
          const stat = stats[i];
          const x = i / stats.length * w;
          const y = h * (1 - stat.colors[c] / nCells);
          if (i != 0) {
            ctx.lineTo(x, y);
          } else {
            ctx.moveTo(x, y);
          }
        }
        ctx.stroke();
      }
    }

    function renderBoard() {
      const canvas = $('#board');
      const {width: w, height: h} = canvas;
      const ctx = canvas.getContext('2d');
      const bitmap = ctx.createImageData(w, h);

      const state = plague.state[0];
      const data = bitmap.data;
      for (let i = 0, j = 0, n = state.nCells; i < n; i++) {
        switch (viewMode) {
          case 0: {  // Show all properties
            let imm = .3 + .67 * state[i].immune/128;
            const inf = state[i].infected ? 128 : 0;
            if (inf) imm /= 2;
            const color = HSB[state[i].code & 0xff];
            data[j++] = inf + color[0] * imm;
            data[j++] = inf + color[1] * imm;
            data[j++] = inf + color[2] * imm;
            break;
          }

          case 1: { // Show infected
            const vir = state[i].infected ? 255 : 0;
            data[j++] = vir;
            data[j++] = vir;
            data[j++] = vir;
            break;
          }

          case 2: { // Show immune
            const imm = Math.min(255, state[i].immune * 256/128);
            data[j++] = imm;
            data[j++] = imm;
            data[j++] = imm;
            break;
          }
        }
        data[j++] = 255;
      }

      ctx.putImageData(bitmap, 0, 0);

      // Draw a circle where an infection is introduced
      if (plague.infectedCell) {
        const cell = plague.infectedCell;
        const x = cell.i % plague.width;
        const y = Math.floor(cell.i / plague.width);
        circles.push({x, y, i: 0, hue: cell.code * 360/256});
      }

      const NFRAMES = 60;
      circles = circles.filter(c => {
        const a = c.i/NFRAMES;
        ctx.beginPath();
        ctx.fillStyle = `hsla(${c.hue}, 100%, 50%, ${1-a})`;

        ctx.arc(c.x, c.y, 5, 0, 2 * Math.PI);
        ctx.closePath();
        ctx.fill();

        return c.i++ < NFRAMES;
      });
    }

    document.addEventListener('keypress', e => {
      switch (e.key) {
        case 's': // Step
          maxFrame = frame + 1;
          break;

        case ' ': // Play/pause
          maxFrame = maxFrame > frame ? frame : Number.POSITIVE_INFINITY
          break;

        case 't':
          const selEl = $('#mode');
          selEl.selectedIndex++;
          if (selEl.selectedIndex < 0) selEl.selectedIndex = 0;

        case 'v':
          setViewMode(viewMode + 1);
      }
    });

    function updateControls() {
      Object.entries(plague)
        .filter(([p]) => /[A-Z]{2,}/.test(p))
        .forEach(([prop, val]) => {
          const target = $(`#${prop}`);
          if (!target) return;
          const label = target.closest('label');
          target.value = val;
          $('span', label).innerText = `${prop} = ${val}`;
        });
    }

    document.addEventListener('change', e => {
      const target = e.target;
      if (target.id in plague) {
        plague[target.id] = parseFloat(target.value, 10);
        updateControls();
      }
    });

    function draw() {
      if (!document.hasFocus() || frame >= maxFrame) {
        setTimeout(draw, .5);
        return;
      }

      frame++;

      plague.tick();

      if (frame % 10 == 0 && plague.stats)  {
        const stat = plague.stats;
        stat.immunity = 100 * stat.nImmunity/plague.nCells / 128;
        stat.infected = 100 * stat.nInfected/plague.nCells;

        stats.push(stat);
        if (stats.length > 200) stats.shift();
      }

      renderBoard();
      renderGraph();
      renderColors();

      window.requestAnimationFrame(draw);
    }

    onload = function() {
      const NPIXELS=500000;
      const canvas = $('#board');
      let {innerWidth: ww, innerHeight: wh} = window;
      ww -= 296;
      canvas.width = Math.floor(Math.sqrt(NPIXELS * ww/wh));
      canvas.height = Math.floor(Math.sqrt(NPIXELS * wh/ww));
      canvas.style.zoom = ww / canvas.width;

      plague = new Plague(canvas.width, canvas.height);

      setViewMode(0);
      updateControls();
      draw();
    }
  </script>
</html>
